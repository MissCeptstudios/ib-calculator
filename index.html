<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Banking Calculator</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 20px; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const IBCalculator = () => {
          const [display, setDisplay] = useState('0');
          const [previousValue, setPreviousValue] = useState(null);
          const [operation, setOperation] = useState(null);
          const [waitingForOperand, setWaitingForOperand] = useState(false);
          const [history, setHistory] = useState([]);
          const [mode, setMode] = useState('basic');
          const [expression, setExpression] = useState('');
          const [openParentheses, setOpenParentheses] = useState(0);
          const [isDarkMode, setIsDarkMode] = useState(true);
          const [memory, setMemory] = useState({
            wacc: 8.5,
            terminalGrowth: 2.5,
            discountRate: 10,
            revenue: 0,
            ebitda: 0,
            netIncome: 0,
            shares: 0,
            marketCap: 0,
            enterprise: 0,
            debtEquityRatio: 4.0,
            debtEbitdaMultiple: 6.0
          });

          const [exchangeRates, setExchangeRates] = useState({
            USD: 1.0000,
            EUR: 0.9150,
            JPY: 142.30,
            GBP: 0.7820,
            AUD: 1.4950,
            CAD: 1.3720,
            CHF: 0.8850,
            CNY: 7.2800,
            HKD: 7.8000,
            NZD: 1.6200,
            PLN: 4.0500,
            SEK: 10.8500
          });
          const [ratesLastUpdated, setRatesLastUpdated] = useState(null);
          const [isLoadingRates, setIsLoadingRates] = useState(false);

          const [selectedCurrency, setSelectedCurrency] = useState('USD');
          const [selectedToCurrency, setSelectedToCurrency] = useState('EUR');
          const [showTutorial, setShowTutorial] = useState(false);
          const [showInstallButton, setShowInstallButton] = useState(false);
          
          const getTutorialContent = () => {
            switch (mode) {
              case 'basic':
                return {
                  title: 'üßÆ Basic Calculator Tutorial',
                  content: [
                    {
                      section: 'üí° What it does:',
                      text: 'Standard calculator with financial shortcuts for quick calculations.'
                    },
                    {
                      section: '‚ú® Key Features:',
                      text: '‚Ä¢ Standard arithmetic operations (+, -, √ó, √∑)\n‚Ä¢ Parentheses for complex expressions\n‚Ä¢ Quick multipliers: √ó1K, √ó1M, √ó1B\n‚Ä¢ Percentage calculations'
                    },
                    {
                      section: 'üìù Step-by-Step Example: Company Valuation',
                      text: 'Calculate a company worth 15 million revenue at 12x multiple:\n\n1Ô∏è‚É£ Enter "15"\n2Ô∏è‚É£ Click "√ó1M" ‚Üí Display shows: 15,000,000\n3Ô∏è‚É£ Click "√ó" (multiply)\n4Ô∏è‚É£ Enter "12" (revenue multiple)\n5Ô∏è‚É£ Click "=" ‚Üí Result: 180,000,000\n6Ô∏è‚É£ This means 180M valuation!'
                    }
                  ]
                };
              
              case 'dcf':
                return {
                  title: 'üìä DCF (Discounted Cash Flow) Tutorial',
                  content: [
                    {
                      section: 'üí° What it does:',
                      text: 'Values a company based on projected future cash flows discounted to present value using sophisticated financial modeling.'
                    },
                    {
                      section: 'üìù Step-by-Step Example: Value a Tech Company',
                      text: 'Let\'s value a SaaS company with $50M free cash flow:\n\n1Ô∏è‚É£ Set WACC (discount rate):\n   ‚Ä¢ Enter "9.5"\n   ‚Ä¢ Click "Set WACC" ‚Üí Memory shows: WACC: 9.5%\n\n2Ô∏è‚É£ Set Terminal Growth:\n   ‚Ä¢ Enter "2.5"\n   ‚Ä¢ Click "Set TG" ‚Üí Memory shows: TG: 2.5%\n\n3Ô∏è‚É£ Calculate DCF:\n   ‚Ä¢ Enter "50" (current FCF in millions)\n   ‚Ä¢ Click "√ó1M" ‚Üí Display: 50,000,000\n   ‚Ä¢ Click "DCF Model" ‚Üí Result: ~$850M enterprise value'
                    }
                  ]
                };
              
              case 'comps':
                return {
                  title: 'üìà Comparable Analysis Tutorial',
                  content: [
                    {
                      section: 'üí° What it does:',
                      text: 'Values companies using trading multiples from similar public companies in the market.'
                    },
                    {
                      section: 'üìù Step-by-Step Example: Analyze a SaaS Company',
                      text: 'Let\'s analyze a cloud software company:\n\n1Ô∏è‚É£ Set Enterprise Value:\n   ‚Ä¢ Enter "1500" (company worth $1.5B)\n   ‚Ä¢ Click "√ó1M" ‚Üí Display: 1,500,000,000\n   ‚Ä¢ Click "Set EV" ‚Üí Memory shows: EV: 1.5B\n\n2Ô∏è‚É£ Calculate Revenue Multiple:\n   ‚Ä¢ Enter "300" (annual revenue in millions)\n   ‚Ä¢ Click "√ó1M" then "EV/Rev"\n   ‚Ä¢ Result: 5.0x ‚Üí This company trades at 5x revenue'
                    }
                  ]
                };
              
              case 'lbo':
                return {
                  title: 'üè¶ LBO (Leveraged Buyout) Tutorial',
                  content: [
                    {
                      section: 'üí° What it does:',
                      text: 'Models private equity acquisitions using debt financing to amplify returns on equity investments.'
                    },
                    {
                      section: 'üìù Step-by-Step Example: $500M LBO Deal',
                      text: 'Model a leveraged buyout of a stable business:\n\n1Ô∏è‚É£ Calculate Total Deal Size:\n   ‚Ä¢ Enter "100" (equity investment in millions)\n   ‚Ä¢ Click "√ó1M" ‚Üí Display: 100,000,000\n   ‚Ä¢ Click "LBO Size" ‚Üí Result: 500M total deal\n   ‚Ä¢ This uses 4:1 debt-to-equity ratio'
                    }
                  ]
                };
              
              case 'forex':
                return {
                  title: 'üí± Foreign Exchange Tutorial',
                  content: [
                    {
                      section: 'üí° What it does:',
                      text: 'Converts currencies using live exchange rates from official financial data sources.'
                    },
                    {
                      section: 'üìù Step-by-Step Example: Convert $10,000 to Euros',
                      text: 'Convert US dollars for a European business trip:\n\n1Ô∏è‚É£ Set Currency Pair:\n   ‚Ä¢ From: "USD" (already selected)\n   ‚Ä¢ To: Select "EUR" from dropdown\n\n2Ô∏è‚É£ Enter Amount:\n   ‚Ä¢ Enter "10000" (ten thousand dollars)\n   ‚Ä¢ Display shows: 10,000\n\n3Ô∏è‚É£ Convert:\n   ‚Ä¢ Click "Convert to EUR"\n   ‚Ä¢ Result: ~9,150 EUR (based on live rate)'
                    }
                  ]
                };
              
              default:
                return { title: 'Calculator Tutorial', content: [] };
            }
          };

          const fetchExchangeRates = async () => {
            setIsLoadingRates(true);
            try {
              // Using a more reliable free API
              const response = await fetch('https://api.fxrates.app/latest?base=USD');
              const data = await response.json();
              
              if (data && data.rates) {
                setExchangeRates({
                  USD: 1.0000,
                  ...data.rates
                });
                setRatesLastUpdated(new Date());
                setHistory(prev => [`Exchange rates updated: ${new Date().toLocaleTimeString()}`, ...prev.slice(0, 19)]);
              }
            } catch (error) {
              console.error('Failed to fetch exchange rates:', error);
              // Fallback to mock data if API fails
              setExchangeRates({
                USD: 1.0000,
                EUR: 0.9150,
                JPY: 142.30,
                GBP: 0.7820,
                AUD: 1.4950,
                CAD: 1.3720,
                CHF: 0.8850,
                CNY: 7.2800,
                HKD: 7.8000,
                NZD: 1.6200,
                PLN: 4.0500,
                SEK: 10.8500
              });
              setHistory(prev => [`Using cached exchange rates`, ...prev.slice(0, 19)]);
            } finally {
              setIsLoadingRates(false);
            }
          };

          useEffect(() => {
            if (mode === 'forex') {
              fetchExchangeRates();
            }
          }, [mode]);
          
          useEffect(() => {
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            
            if (!isInstalled) {
              window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredPrompt = e;
                setShowInstallButton(true);
              });

              window.addEventListener('appinstalled', () => {
                setShowInstallButton(false);
                window.deferredPrompt = null;
              });
            }
          }, []);

          const inputNumber = (num) => {
            if (waitingForOperand) {
              setDisplay(String(num));
              setWaitingForOperand(false);
            } else {
              setDisplay(display === '0' ? String(num) : display + num);
            }
          };

          const inputDecimal = () => {
            if (waitingForOperand) {
              setDisplay('0.');
              setWaitingForOperand(false);
            } else if (display.indexOf('.') === -1) {
              setDisplay(display + '.');
            }
          };

          const clear = () => {
            setDisplay('0');
            setPreviousValue(null);
            setOperation(null);
            setWaitingForOperand(false);
            setExpression('');
            setOpenParentheses(0);
          };

          const calculate = (firstValue, secondValue, operation) => {
            switch (operation) {
              case '+': return firstValue + secondValue;
              case '-': return firstValue - secondValue;
              case '√ó': return firstValue * secondValue;
              case '√∑': return secondValue !== 0 ? firstValue / secondValue : 0;
              case '%': return firstValue % secondValue;
              case '^': return Math.pow(firstValue, secondValue);
              default: return secondValue;
            }
          };

          const performOperation = (nextOperation) => {
            const inputValue = parseFloat(display);
            
            if (previousValue === null) {
              setPreviousValue(inputValue);
            } else if (operation) {
              const currentValue = previousValue || 0;
              const newValue = calculate(currentValue, inputValue, operation);
              setDisplay(String(newValue));
              setPreviousValue(newValue);
              const calculation = `${formatNumber(currentValue)} ${operation} ${formatNumber(inputValue)} = ${formatNumber(newValue)}`;
              setHistory(prev => [calculation, ...prev.slice(0, 19)]);
            }
            setWaitingForOperand(true);
            setOperation(nextOperation);
          };

          const performEquals = () => {
            const inputValue = parseFloat(display);
            if (previousValue !== null && operation) {
              const newValue = calculate(previousValue, inputValue, operation);
              const calculation = `${formatNumber(previousValue)} ${operation} ${formatNumber(inputValue)} = ${formatNumber(newValue)}`;
              setHistory(prev => [calculation, ...prev.slice(0, 19)]);
              setDisplay(String(newValue));
              setPreviousValue(null);
              setOperation(null);
              setWaitingForOperand(true);
            }
          };

          const calculateDCF = () => {
            const fcf = parseFloat(display);
            if (isNaN(fcf) || fcf <= 0) {
              setDisplay('Error: Invalid FCF');
              return;
            }
            
            const wacc = memory.wacc / 100;
            const terminalGrowth = memory.terminalGrowth / 100;
            const projectionYears = 5;
            
            // Validate inputs
            if (wacc <= terminalGrowth) {
              setDisplay('Error: WACC must be > Terminal Growth');
              return;
            }
            
            let pv = 0;
            const initialGrowth = 0.15;
            const growthDecline = 0.02;
            
            for (let year = 1; year <= projectionYears; year++) {
              const yearGrowth = Math.max(initialGrowth - (growthDecline * (year - 1)), terminalGrowth);
              const fcfYear = fcf * Math.pow(1 + yearGrowth, year);
              pv += fcfYear / Math.pow(1 + wacc, year);
            }
            
            const finalYearGrowth = Math.max(initialGrowth - (growthDecline * projectionYears), terminalGrowth);
            const terminalFCF = fcf * Math.pow(1 + finalYearGrowth, projectionYears) * (1 + terminalGrowth);
            const terminalValue = terminalFCF / (wacc - terminalGrowth);
            const terminalPV = terminalValue / Math.pow(1 + wacc, projectionYears);
            
            const enterpriseValue = pv + terminalPV;
            const result = Math.round(enterpriseValue);
            
            setDisplay(String(result));
            setHistory(prev => [`DCF: FCF=${formatNumber(fcf)}, WACC=${memory.wacc}%, TG=${memory.terminalGrowth}% = ${formatNumber(result)}`, ...prev.slice(0, 19)]);
            setWaitingForOperand(true);
          };

          const calculateMultiple = (metric) => {
            const value = parseFloat(display);
            if (isNaN(value) || value === 0) {
              setDisplay('Error: Invalid input');
              return;
            }
            
            let result;
            let calculation;
            
            switch (metric) {
              case 'ev_ebitda':
                if (memory.enterprise === 0) {
                  setDisplay('Error: Set EV first');
                  return;
                }
                result = memory.enterprise / value;
                calculation = `EV/EBITDA: ${formatNumber(memory.enterprise)} / ${formatNumber(value)} = ${result.toFixed(1)}x`;
                break;
              case 'pe':
                if (memory.marketCap === 0) {
                  setDisplay('Error: Set MCap first');
                  return;
                }
                result = memory.marketCap / value;
                calculation = `P/E: ${formatNumber(memory.marketCap)} / ${formatNumber(value)} = ${result.toFixed(1)}x`;
                break;
              case 'ev_revenue':
                if (memory.enterprise === 0) {
                  setDisplay('Error: Set EV first');
                  return;
                }
                result = memory.enterprise / value;
                calculation = `EV/Revenue: ${formatNumber(memory.enterprise)} / ${formatNumber(value)} = ${result.toFixed(1)}x`;
                break;
              case 'price_book':
                if (memory.marketCap === 0) {
                  setDisplay('Error: Set MCap first');
                  return;
                }
                result = memory.marketCap / value;
                calculation = `P/B: ${formatNumber(memory.marketCap)} / ${formatNumber(value)} = ${result.toFixed(1)}x`;
                break;
              case 'ev_sales':
                if (memory.enterprise === 0) {
                  setDisplay('Error: Set EV first');
                  return;
                }
                result = memory.enterprise / value;
                calculation = `EV/Sales: ${formatNumber(memory.enterprise)} / ${formatNumber(value)} = ${result.toFixed(1)}x`;
                break;
              default:
                setDisplay('Error: Unknown metric');
                return;
            }
            
            setDisplay(String(result.toFixed(2)));
            setHistory(prev => [calculation, ...prev.slice(0, 19)]);
            setWaitingForOperand(true);
          };

          const calculateIRR = () => {
            const initialInvestment = memory.enterprise || parseFloat(display);
            const finalValue = parseFloat(display);
            const years = 5;
            
            if (initialInvestment <= 0 || finalValue <= 0) {
              setDisplay('Error');
              return;
            }
            
            const irr = Math.pow(finalValue / initialInvestment, 1/years) - 1;
            const result = irr * 100;
            
            setDisplay(String(result.toFixed(1)));
            setHistory(prev => [`IRR: ${formatNumber(initialInvestment)} ‚Üí ${formatNumber(finalValue)} (${years}y) = ${result.toFixed(1)}%`, ...prev.slice(0, 19)]);
            setWaitingForOperand(true);
          };

          const storeMemory = (key) => {
            const value = parseFloat(display);
            setMemory(prev => ({ ...prev, [key]: value }));
            setHistory(prev => [`Stored ${key.toUpperCase()}: ${formatNumber(value)}`, ...prev.slice(0, 19)]);
          };

          const recallMemory = (key) => {
            setDisplay(String(memory[key]));
            setWaitingForOperand(true);
          };

          const convertCurrency = (fromCurrency, toCurrency, amount) => {
            const usdAmount = amount / exchangeRates[fromCurrency];
            return usdAmount * exchangeRates[toCurrency];
          };

          const performForexConversion = (toCurrency) => {
            const amount = parseFloat(display);
            if (isNaN(amount) || amount === 0) {
              setDisplay('Error: Invalid amount');
              return;
            }
            
            if (!exchangeRates[selectedCurrency] || !exchangeRates[toCurrency]) {
              setDisplay('Error: Currency not available');
              return;
            }
            
            const convertedAmount = convertCurrency(selectedCurrency, toCurrency, amount);
            const formattedResult = convertedAmount < 0.01 ? convertedAmount.toFixed(6) : convertedAmount.toFixed(4);
            setDisplay(String(formattedResult));
            setHistory(prev => [`${amount.toFixed(2)} ${selectedCurrency} = ${formattedResult} ${toCurrency}`, ...prev.slice(0, 19)]);
            setWaitingForOperand(true);
          };

          const getExchangeRate = (fromCurrency, toCurrency) => {
            return convertCurrency(fromCurrency, toCurrency, 1);
          };

          const getCurrencyName = (code) => {
            const names = {
              USD: 'US Dollar',
              EUR: 'Euro',
              JPY: 'Japanese Yen',
              GBP: 'British Pound',
              AUD: 'Australian Dollar',
              CAD: 'Canadian Dollar',
              CHF: 'Swiss Franc',
              CNY: 'Chinese Yuan',
              HKD: 'Hong Kong Dollar',
              NZD: 'New Zealand Dollar',
              PLN: 'Polish Zloty',
              SEK: 'Swedish Krona'
            };
            return names[code] || code;
          };

          const swapCurrencies = () => {
            const temp = selectedCurrency;
            setSelectedCurrency(selectedToCurrency);
            setSelectedToCurrency(temp);
          };

          const formatNumber = (num) => {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            if (Math.abs(num) >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (Math.abs(num) >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (Math.abs(num) >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
          };

          const Button = ({ onClick, className = '', children, variant = 'default', size = 'normal' }) => {
            const baseClasses = 'font-semibold rounded-lg transition-all duration-200 active:scale-95 shadow-sm border';
            const sizes = {
              normal: 'h-10 sm:h-12 text-xs sm:text-sm px-2 sm:px-3',
              small: 'h-8 sm:h-10 text-xs px-1 sm:px-2',
              large: 'h-12 sm:h-14 text-sm sm:text-base px-3 sm:px-4'
            };
            
            const variants = isDarkMode ? {
              default: 'bg-gray-700 hover:bg-gray-600 text-gray-100 border-gray-600 hover:border-gray-500',
              operator: 'bg-gray-800 hover:bg-gray-700 text-yellow-400 border-gray-600 hover:border-yellow-400',
              equals: 'bg-yellow-500 hover:bg-yellow-400 text-black font-bold border-yellow-400',
              function: 'bg-gray-800 hover:bg-gray-700 text-blue-400 border-gray-600',
              clear: 'bg-red-600 hover:bg-red-500 text-white border-red-500',
              ib: 'bg-yellow-600 hover:bg-yellow-500 text-black font-semibold border-yellow-500',
              memory: 'bg-purple-600 hover:bg-purple-500 text-white border-purple-500',
              swap: 'bg-green-600 hover:bg-green-500 text-white font-semibold border-green-500',
              theme: 'bg-gray-600 hover:bg-gray-500 text-yellow-400 border-gray-500 hover:border-yellow-400',
              help: 'bg-blue-600 hover:bg-blue-500 text-white border-blue-500 hover:border-blue-400',
              install: 'bg-green-600 hover:bg-green-700 text-white font-semibold border-green-600 shadow-lg animate-pulse'
            } : {
              default: 'bg-white hover:bg-gray-50 text-black border-gray-400 hover:border-gray-500 shadow-md',
              operator: 'bg-orange-500 hover:bg-orange-600 text-white border-orange-500 shadow-md',
              equals: 'bg-green-600 hover:bg-green-700 text-white font-bold border-green-600 shadow-md',
              function: 'bg-blue-600 hover:bg-blue-700 text-white border-blue-600 shadow-md',
              clear: 'bg-red-600 hover:bg-red-700 text-white border-red-600 shadow-md',
              ib: 'bg-purple-600 hover:bg-purple-700 text-white font-semibold border-purple-600 shadow-md',
              memory: 'bg-indigo-600 hover:bg-indigo-700 text-white border-indigo-600 shadow-md',
              swap: 'bg-emerald-600 hover:bg-emerald-700 text-white font-semibold border-emerald-600 shadow-md',
              theme: 'bg-amber-500 hover:bg-amber-600 text-black border-amber-500 hover:border-amber-600 shadow-md',
              help: 'bg-cyan-600 hover:bg-cyan-700 text-white border-cyan-600 shadow-md',
              install: 'bg-green-600 hover:bg-green-700 text-white font-semibold border-green-600 shadow-lg animate-pulse'
            };
            
            return (
              <button
                className={`${baseClasses} ${sizes[size]} ${variants[variant]} ${className}`}
                onClick={onClick}
              >
                {children}
              </button>
            );
          };

          return (
            <div className={`max-w-4xl mx-auto rounded-2xl shadow-2xl p-3 sm:p-4 md:p-6 mt-4 sm:mt-6 md:mt-8 border transition-all duration-300 ${
              isDarkMode 
                ? 'bg-gray-900 border-gray-700' 
                : 'bg-white border-gray-200'
            }`}>
              {/* Header - Fixed to show only once */}
              <div className="text-center mb-4 sm:mb-6">
                <div className="flex items-center justify-between mb-3 sm:mb-4">
                  <Button
                    variant="help"
                    size="small"
                    onClick={() => setShowTutorial(true)}
                    className="w-10 sm:w-12 h-6 sm:h-8 flex items-center justify-center text-xs sm:text-sm"
                    title={`Learn how to use ${mode.toUpperCase()} mode with examples`}
                  >
                    <span className="text-xs sm:text-sm">‚ùì</span>
                  </Button>
                  
                  <div className="flex flex-col items-center">
                    <h1 className={`text-xl sm:text-2xl md:text-3xl font-bold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                      Investment Banking Calculator
                    </h1>
                    {showInstallButton && (
                      <Button
                        variant="install"
                        size="small"
                        onClick={() => {
                          if (window.deferredPrompt) {
                            window.deferredPrompt.prompt();
                            window.deferredPrompt.userChoice.then((choiceResult) => {
                              if (choiceResult.outcome === 'accepted') {
                                setShowInstallButton(false);
                              }
                              window.deferredPrompt = null;
                            });
                          }
                        }}
                        className="mb-2 px-4 py-2 text-sm"
                      >
                        üì± Install App
                      </Button>
                    )}
                  </div>
                  
                  <Button
                    variant="theme"
                    size="small"
                    onClick={() => setIsDarkMode(!isDarkMode)}
                    className="w-10 sm:w-12 h-6 sm:h-8 flex items-center justify-center text-xs sm:text-sm"
                    title={`Switch to ${isDarkMode ? 'light' : 'dark'} mode`}
                  >
                    {isDarkMode ? '‚òÄÔ∏è' : 'üåô'}
                  </Button>
                </div>
                <p className={`text-xs sm:text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-800'}`}>
                  Professional financial modeling and analysis tool by MissCept
                </p>
              </div>

              {/* Tutorial Help Cloud */}
              {showTutorial && (
                <div className="mb-4">
                  <div className={`relative w-full rounded-lg border shadow-lg ${
                    isDarkMode 
                      ? 'bg-gray-800 border-gray-600' 
                      : 'bg-white border-gray-300'
                  }`}>
                    <div className={`absolute -top-2 left-8 w-4 h-4 transform rotate-45 ${
                      isDarkMode ? 'bg-gray-800 border-l border-t border-gray-600' : 'bg-white border-l border-t border-gray-300'
                    }`}></div>
                    
                    <div className="p-4">
                      <div className="flex justify-between items-center mb-3">
                        <h3 className={`text-sm font-bold ${isDarkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                          {getTutorialContent().title}
                        </h3>
                        <button
                          onClick={() => setShowTutorial(false)}
                          className={`text-xs w-5 h-5 rounded-full flex items-center justify-center transition-colors ${
                            isDarkMode ? 'text-gray-400 hover:bg-gray-700 hover:text-white' : 'text-gray-600 hover:bg-gray-100'
                          }`}
                        >
                          ‚úï
                        </button>
                      </div>
                      
                      <div className="space-y-3 max-h-60 overflow-y-auto">
                        {getTutorialContent().content.map((item, index) => (
                          <div key={index} className={`p-3 rounded ${
                            isDarkMode 
                              ? 'bg-gray-700' 
                              : 'bg-blue-50 border border-blue-200'
                          }`}>
                            <h5 className={`font-semibold mb-2 text-sm ${
                              isDarkMode ? 'text-orange-400' : 'text-orange-600'
                            }`}>
                              {item.section}
                            </h5>
                            <p className={`text-sm whitespace-pre-line leading-relaxed ${
                              isDarkMode ? 'text-gray-200' : 'text-gray-700'
                            }`}>
                              {item.text}
                            </p>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Display */}
              <div className="mb-4 sm:mb-6">
                <div className={`p-4 sm:p-6 rounded-xl mb-3 sm:mb-4 border transition-all duration-300 ${
                  isDarkMode 
                    ? 'bg-black text-white border-gray-600' 
                    : 'bg-gray-100 text-black border-gray-400 shadow-inner'
                }`}>
                  <div className="text-right text-xl sm:text-2xl md:text-3xl font-mono overflow-hidden mb-2">
                    {formatNumber(parseFloat(display) || 0)}
                  </div>
                  <div className={`text-right text-sm sm:text-lg mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    {parseFloat(display) >= 1000000 ? `${parseFloat(display).toLocaleString()}` : display}
                  </div>
                  {operation && previousValue !== null && (
                    <div className={`text-right text-xs sm:text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-700'}`}>
                      {formatNumber(previousValue)} {operation}
                    </div>
                  )}
                </div>

                {/* Mode Selector */}
                <div className="flex gap-1 sm:gap-2 mb-3 sm:mb-4">
                  {[
                    { key: 'basic', label: 'BASIC' },
                    { key: 'dcf', label: 'DCF' },
                    { key: 'comps', label: 'COMPS' },
                    { key: 'lbo', label: 'LBO' },
                    { key: 'forex', label: 'FOREX' }
                  ].map((m) => (
                    <Button
                      key={m.key}
                      variant={mode === m.key ? 'ib' : 'default'}
                      size="small"
                      onClick={() => {
                        setMode(m.key);
                        if (m.key === 'forex') {
                          setHistory([]);
                        }
                      }}
                      className="flex-1 text-xs sm:text-sm"
                    >
                      {m.label}
                    </Button>
                  ))}
                </div>

                {/* Memory/Status Display */}
                {(mode !== 'basic' && mode !== 'forex') && (
                  <div className={`p-2 sm:p-3 rounded-lg mb-3 sm:mb-4 border transition-all duration-300 ${
                    isDarkMode 
                      ? 'bg-gray-800 border-gray-600' 
                      : 'bg-white border-gray-400 shadow-md'
                  }`}>
                    <div>
                      <div className={`text-xs mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-800'}`}>
                        Memory Values
                      </div>
                      <div className="grid grid-cols-2 sm:grid-cols-4 gap-1 sm:gap-2 text-xs">
                        <div className={`px-1 sm:px-2 py-1 rounded transition-all duration-300 text-center ${
                          isDarkMode 
                            ? 'bg-gray-700 text-gray-300' 
                            : 'bg-gray-200 text-black border border-gray-400'
                        }`}>
                          <div className="font-semibold">WACC</div>
                          <div>{memory.wacc}%</div>
                        </div>
                        <div className={`px-1 sm:px-2 py-1 rounded transition-all duration-300 text-center ${
                          isDarkMode 
                            ? 'bg-gray-700 text-gray-300' 
                            : 'bg-gray-200 text-black border border-gray-400'
                        }`}>
                          <div className="font-semibold">TG</div>
                          <div>{memory.terminalGrowth}%</div>
                        </div>
                        <div className={`px-1 sm:px-2 py-1 rounded transition-all duration-300 text-center ${
                          isDarkMode 
                            ? 'bg-gray-700 text-gray-300' 
                            : 'bg-gray-200 text-black border border-gray-400'
                        }`}>
                          <div className="font-semibold">EV</div>
                          <div>{formatNumber(memory.enterprise)}</div>
                        </div>
                        <div className={`px-1 sm:px-2 py-1 rounded transition-all duration-300 text-center ${
                          isDarkMode 
                            ? 'bg-gray-700 text-gray-300' 
                            : 'bg-gray-200 text-black border border-gray-400'
                        }`}>
                          <div className="font-semibold">MCap</div>
                          <div>{formatNumber(memory.marketCap)}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* History */}
                {history.length > 0 && (
                  <div className={`p-3 rounded-lg max-h-32 overflow-y-auto border transition-all duration-300 ${
                    isDarkMode 
                      ? 'bg-gray-800 border-gray-600' 
                      : 'bg-gray-100 border-gray-200'
                  }`}>
                    <div className="flex justify-between items-center mb-2">
                      <div className={`text-xs ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>History</div>
                      <Button
                        variant="clear"
                        size="small"
                        onClick={() => setHistory([])}
                        className="h-5 px-2 text-xs"
                      >
                        Clear
                      </Button>
                    </div>
                    {history.slice(0, 5).map((calc, index) => (
                      <div key={index} className={`text-xs font-mono mb-1 p-1 rounded transition-all duration-300 ${
                        isDarkMode 
                          ? 'text-gray-300 bg-gray-700' 
                          : 'text-gray-700 bg-white border border-gray-200'
                      }`}>
                        {calc}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Mode-specific functions */}
              {mode === 'forex' && (
                <div className="mb-3 sm:mb-4">
                  <div className="grid grid-cols-1 sm:grid-cols-5 gap-2 sm:gap-4 mb-3 sm:mb-4">
                    <div className="sm:col-span-2">
                      <label className={`block text-xs mb-1 sm:mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-800'}`}>
                        From Currency
                      </label>
                      <select
                        value={selectedCurrency}
                        onChange={(e) => setSelectedCurrency(e.target.value)}
                        className={`w-full border rounded-lg px-2 sm:px-3 py-2 text-xs sm:text-sm focus:outline-none transition-all duration-300 ${
                          isDarkMode 
                            ? 'bg-gray-700 text-white border-gray-500 focus:border-yellow-400' 
                            : 'bg-white text-gray-800 border-gray-300 focus:border-yellow-500'
                        }`}
                      >
                        {['USD', 'EUR', 'JPY', 'GBP', 'AUD', 'CAD', 'CHF', 'CNY', 'HKD', 'NZD', 'PLN', 'SEK'].map((currency) => (
                          <option key={currency} value={currency}>
                            {currency} - {getCurrencyName(currency)}
                          </option>
                        ))}
                        {Object.keys(exchangeRates).filter(c => !['USD', 'EUR', 'JPY', 'GBP', 'AUD', 'CAD', 'CHF', 'CNY', 'HKD', 'NZD', 'PLN', 'SEK'].includes(c)).map((currency) => (
                          <option key={currency} value={currency}>
                            {currency} - {getCurrencyName(currency)}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div className="flex items-end justify-center">
                      <Button 
                        variant="swap" 
                        size="small"
                        onClick={swapCurrencies}
                        className="h-8 sm:h-10 w-8 sm:w-10 flex items-center justify-center p-0 text-sm sm:text-base"
                        title="Swap currencies"
                      >
                        ‚áÑ
                      </Button>
                    </div>
                    <div className="sm:col-span-2">
                      <label className={`block text-xs mb-1 sm:mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-800'}`}>
                        To Currency
                      </label>
                      <select
                        value={selectedToCurrency}
                        onChange={(e) => setSelectedToCurrency(e.target.value)}
                        className={`w-full border rounded-lg px-2 sm:px-3 py-2 text-xs sm:text-sm focus:outline-none transition-all duration-300 ${
                          isDarkMode 
                            ? 'bg-gray-700 text-white border-gray-500 focus:border-yellow-400' 
                            : 'bg-white text-gray-800 border-gray-300 focus:border-yellow-500'
                        }`}
                      >
                        {['USD', 'EUR', 'JPY', 'GBP', 'AUD', 'CAD', 'CHF', 'CNY', 'HKD', 'NZD', 'PLN', 'SEK'].filter(c => c !== selectedCurrency).map((currency) => (
                          <option key={currency} value={currency}>
                            {currency} - {getCurrencyName(currency)}
                          </option>
                        ))}
                        {Object.keys(exchangeRates).filter(c => c !== selectedCurrency && !['USD', 'EUR', 'JPY', 'GBP', 'AUD', 'CAD', 'CHF', 'CNY', 'HKD', 'NZD', 'PLN', 'SEK'].includes(c)).map((currency) => (
                          <option key={currency} value={currency}>
                            {currency} - {getCurrencyName(currency)}
                          </option>
                        ))}
                      </select>
                    </div>
                  </div>
                  <div className="grid grid-cols-1 gap-2">
                    <Button variant="ib" onClick={() => performForexConversion(selectedToCurrency)} className="text-xs sm:text-sm">
                      Convert to {selectedToCurrency}
                    </Button>
                  </div>
                </div>
              )}

              {mode === 'dcf' && (
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-1 sm:gap-2 mb-3 sm:mb-4">
                  <Button variant="ib" onClick={calculateDCF} className="text-xs sm:text-sm">DCF Model</Button>
                  <Button variant="memory" onClick={() => storeMemory('wacc')} className="text-xs sm:text-sm">Set WACC</Button>
                  <Button variant="memory" onClick={() => storeMemory('terminalGrowth')} className="text-xs sm:text-sm">Set TG</Button>
                  <Button variant="ib" onClick={calculateIRR} className="text-xs sm:text-sm">IRR</Button>
                </div>
              )}

              {mode === 'comps' && (
                <div className="mb-3 sm:mb-4">
                  <div className="grid grid-cols-2 sm:grid-cols-5 gap-1 sm:gap-2 mb-2">
                    <Button variant="ib" size="small" onClick={() => calculateMultiple('ev_ebitda')} className="text-xs">EV/EBITDA</Button>
                    <Button variant="ib" size="small" onClick={() => calculateMultiple('pe')} className="text-xs">P/E</Button>
                    <Button variant="ib" size="small" onClick={() => calculateMultiple('ev_revenue')} className="text-xs">EV/Rev</Button>
                    <Button variant="ib" size="small" onClick={() => calculateMultiple('price_book')} className="text-xs">P/B</Button>
                    <Button variant="ib" size="small" onClick={() => calculateMultiple('ev_sales')} className="text-xs">EV/Sales</Button>
                  </div>
                </div>
              )}

              {mode === 'lbo' && (
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-1 sm:gap-2 mb-3 sm:mb-4">
                  <Button variant="ib" size="small" onClick={() => {
                    const equity = parseFloat(display);
                    const debt = equity * memory.debtEquityRatio;
                    const totalCost = equity + debt;
                    setDisplay(String(totalCost));
                    setHistory(prev => [`LBO: Equity=${formatNumber(equity)}, Debt=${formatNumber(debt)}, Total=${formatNumber(totalCost)}`, ...prev.slice(0, 19)]);
                    setWaitingForOperand(true);
                  }} className="text-xs">LBO Size</Button>
                  <Button variant="ib" size="small" onClick={() => {
                    const ebitda = parseFloat(display);
                    const debtCapacity = ebitda * memory.debtEbitdaMultiple;
                    setDisplay(String(debtCapacity));
                    setHistory(prev => [`Debt: ${formatNumber(ebitda)} √ó ${memory.debtEbitdaMultiple}x = ${formatNumber(debtCapacity)}`, ...prev.slice(0, 19)]);
                    setWaitingForOperand(true);
                  }} className="text-xs">Debt Cap</Button>
                  <Button variant="ib" size="small" onClick={calculateIRR} className="text-xs">IRR</Button>
                  <Button variant="ib" size="small" onClick={() => {
                    const currentVal = parseFloat(display);
                    const moic = currentVal / (memory.enterprise || 1);
                    setDisplay(String(moic.toFixed(1)));
                    setHistory(prev => [`MOIC: ${formatNumber(currentVal)} / ${formatNumber(memory.enterprise)} = ${moic.toFixed(1)}x`, ...prev.slice(0, 19)]);
                    setWaitingForOperand(true);
                  }} className="text-xs">MOIC</Button>
                </div>
              )}

              {/* Memory Functions */}
              {(mode === 'dcf' || mode === 'comps' || mode === 'lbo') && (
                <div className="grid grid-cols-3 sm:grid-cols-6 gap-1 sm:gap-2 mb-3 sm:mb-4">
                  <Button variant="memory" size="small" onClick={() => storeMemory('enterprise')} className="text-xs">Set EV</Button>
                  <Button variant="memory" size="small" onClick={() => storeMemory('marketCap')} className="text-xs">Set MCap</Button>
                  <Button variant="memory" size="small" onClick={() => storeMemory('revenue')} className="text-xs">Set Rev</Button>
                  <Button variant="memory" size="small" onClick={() => storeMemory('ebitda')} className="text-xs">Set EBITDA</Button>
                  <Button variant="memory" size="small" onClick={() => recallMemory('enterprise')} className="text-xs">Rcl EV</Button>
                  <Button variant="memory" size="small" onClick={() => recallMemory('marketCap')} className="text-xs">Rcl MCap</Button>
                </div>
              )}

              {/* Basic Calculator Layout */}
              <div className="space-y-2 sm:space-y-3">
                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button variant="clear" onClick={clear}>AC</Button>
                  <Button variant="function" onClick={() => setDisplay(display.slice(0, -1) || '0')}>‚å´</Button>
                  <Button variant="function" onClick={() => {
                    const val = parseFloat(display) || 0;
                    setDisplay(String(Math.sqrt(val).toFixed(4)));
                    setWaitingForOperand(true);
                  }}>‚àö</Button>
                  <Button variant="function" onClick={() => performOperation('^')}>^</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button variant="operator" onClick={() => performOperation('%')}>%</Button>
                  <Button variant="operator" onClick={() => performOperation('√∑')}>√∑</Button>
                  <Button variant="operator" onClick={() => performOperation('√ó')}>√ó</Button>
                  <Button variant="operator" onClick={() => performOperation('-')}>-</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button onClick={() => inputNumber(7)}>7</Button>
                  <Button onClick={() => inputNumber(8)}>8</Button>
                  <Button onClick={() => inputNumber(9)}>9</Button>
                  <Button variant="function" onClick={() => {
                    const val = parseFloat(display);
                    setDisplay(String(val * 1000000));
                    setWaitingForOperand(true);
                  }}>√ó1M</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button onClick={() => inputNumber(4)}>4</Button>
                  <Button onClick={() => inputNumber(5)}>5</Button>
                  <Button onClick={() => inputNumber(6)}>6</Button>
                  <Button variant="function" onClick={() => {
                    const val = parseFloat(display);
                    setDisplay(String(val * 1000));
                    setWaitingForOperand(true);
                  }}>√ó1K</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button onClick={() => inputNumber(1)}>1</Button>
                  <Button onClick={() => inputNumber(2)}>2</Button>
                  <Button onClick={() => inputNumber(3)}>3</Button>
                  <Button variant="operator" onClick={() => performOperation('+')}>+</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button variant="function" onClick={() => {
                    const val = parseFloat(display);
                    setDisplay(String(val * 1000000000));
                    setWaitingForOperand(true);
                  }}>√ó1B</Button>
                  <Button onClick={() => inputNumber(0)}>0</Button>
                  <Button onClick={inputDecimal}>.</Button>
                  <Button variant="equals" onClick={performEquals}>=</Button>
                </div>
              </div>

              {/* Footer */}
              <div className={`text-xs mt-4 sm:mt-6 text-center transition-all duration-300 ${
                isDarkMode ? 'text-gray-400' : 'text-gray-600'
              }`}>
                <div className="mb-1">IB Calculator v2.1 | Enhanced Financial Modeling Suite</div>
                <div className="hidden sm:block">DCF: Discounted Cash Flow | LBO: Leveraged Buyout | Comps: Comparable Analysis | Forex: Currency Conversion</div>
                {mode === 'forex' && (
                  <div className={`mt-1 text-center ${isDarkMode ? 'text-green-400' : 'text-green-600'}`}>
                    Live exchange rates from ExchangeRate-API
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<IBCalculator />, document.getElementById('root'));
    </script>
    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js');
          });
        }
    </script>
</body>
</html>
