<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Banking Calculator</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 20px; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const IBCalculator = () => {
          const [display, setDisplay] = useState('0');
          const [previousValue, setPreviousValue] = useState(null);
          const [operation, setOperation] = useState(null);
          const [waitingForOperand, setWaitingForOperand] = useState(false);
          const [history, setHistory] = useState([]);
          const [mode, setMode] = useState('basic');
          const [isDarkMode, setIsDarkMode] = useState(true);
          const [showInstallButton, setShowInstallButton] = useState(false);
          const [memory, setMemory] = useState({
            wacc: 8.5,
            terminalGrowth: 2.5,
            discountRate: 10,
            revenue: 0,
            ebitda: 0,
            netIncome: 0,
            shares: 0,
            marketCap: 0,
            enterprise: 0,
            debtEquityRatio: 4.0,
            debtEbitdaMultiple: 6.0
          });

          const [exchangeRates, setExchangeRates] = useState({
            USD: 1.0000,
            EUR: 0.9150,
            JPY: 142.30,
            GBP: 0.7820,
            AUD: 1.4950,
            CAD: 1.3720,
            CHF: 0.8850,
            CNY: 7.2800,
            HKD: 7.8000,
            NZD: 1.6200,
            PLN: 4.0500,
            SEK: 10.8500
          });
          const [isLoadingRates, setIsLoadingRates] = useState(false);
          const [selectedCurrency, setSelectedCurrency] = useState('USD');
          const [selectedToCurrency, setSelectedToCurrency] = useState('EUR');
          const [showTutorial, setShowTutorial] = useState(false);

          // PWA Install Logic
          useEffect(() => {
            console.log('🔍 PWA Install Debug - Starting checks...');
            
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true ||
                                document.referrer.includes('android-app://');
            
            console.log('📱 Standalone mode detected:', isStandalone);
            
            if (!isStandalone) {
              console.log('✅ Not in standalone mode - setting up install listeners');
              
              const handleBeforeInstallPrompt = (e) => {
                console.log('🎯 beforeinstallprompt event fired!', e);
                e.preventDefault();
                window.deferredPrompt = e;
                setShowInstallButton(true);
                console.log('📱 Install button should now be visible');
              };

              const handleAppInstalled = () => {
                console.log('✅ App installed successfully');
                setShowInstallButton(false);
                window.deferredPrompt = null;
              };

              if (window.deferredPrompt) {
                console.log('🔄 Found existing deferred prompt');
                setShowInstallButton(true);
              }

              window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
              window.addEventListener('appinstalled', handleAppInstalled);

              setTimeout(() => {
                console.log('🔍 PWA Criteria Debug:');
                console.log('- HTTPS:', location.protocol === 'https:');
                console.log('- Service Worker registered:', 'serviceWorker' in navigator);
                console.log('- Has manifest:', document.querySelector('link[rel="manifest"]') !== null);
                console.log('- Install button state:', showInstallButton);
              }, 3000);

              return () => {
                window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                window.removeEventListener('appinstalled', handleAppInstalled);
              };
            } else {
              setShowInstallButton(false);
              console.log('ℹ️ App is running in standalone mode - no install button needed');
            }
          }, []);

          const fetchExchangeRates = async () => {
            setIsLoadingRates(true);
            try {
              const response = await fetch('https://api.fxrates.app/latest?base=USD');
              const data = await response.json();
              
              if (data && data.rates) {
                setExchangeRates({
                  USD: 1.0000,
                  ...data.rates
                });
                setHistory(prev => [`Exchange rates updated: ${new Date().toLocaleTimeString()}`, ...prev.slice(0, 19)]);
              }
            } catch (error) {
              console.error('Failed to fetch exchange rates:', error);
              setExchangeRates({
                USD: 1.0000,
                EUR: 0.9150,
                JPY: 142.30,
                GBP: 0.7820,
                AUD: 1.4950,
                CAD: 1.3720,
                CHF: 0.8850,
                CNY: 7.2800,
                HKD: 7.8000,
                NZD: 1.6200,
                PLN: 4.0500,
                SEK: 10.8500
              });
              setHistory(prev => [`Using cached exchange rates`, ...prev.slice(0, 19)]);
            } finally {
              setIsLoadingRates(false);
            }
          };

          useEffect(() => {
            if (mode === 'forex') {
              fetchExchangeRates();
            }
          }, [mode]);

          const inputNumber = (num) => {
            if (waitingForOperand) {
              setDisplay(String(num));
              setWaitingForOperand(false);
            } else {
              setDisplay(display === '0' ? String(num) : display + num);
            }
          };

          const inputDecimal = () => {
            if (waitingForOperand) {
              setDisplay('0.');
              setWaitingForOperand(false);
            } else if (display.indexOf('.') === -1) {
              setDisplay(display + '.');
            }
          };

          const clear = () => {
            setDisplay('0');
            setPreviousValue(null);
            setOperation(null);
            setWaitingForOperand(false);
          };

          const calculate = (firstValue, secondValue, operation) => {
            switch (operation) {
              case '+': return firstValue + secondValue;
              case '-': return firstValue - secondValue;
              case '×': return firstValue * secondValue;
              case '÷': return secondValue !== 0 ? firstValue / secondValue : 0;
              case '%': return firstValue % secondValue;
              case '^': return Math.pow(firstValue, secondValue);
              default: return secondValue;
            }
          };

          const performOperation = (nextOperation) => {
            const inputValue = parseFloat(display);
            
            if (previousValue === null) {
              setPreviousValue(inputValue);
            } else if (operation) {
              const currentValue = previousValue || 0;
              const newValue = calculate(currentValue, inputValue, operation);
              setDisplay(String(newValue));
              setPreviousValue(newValue);
              const calculation = `${formatNumber(currentValue)} ${operation} ${formatNumber(inputValue)} = ${formatNumber(newValue)}`;
              setHistory(prev => [calculation, ...prev.slice(0, 19)]);
            }
            setWaitingForOperand(true);
            setOperation(nextOperation);
          };

          const performEquals = () => {
            const inputValue = parseFloat(display);
            if (previousValue !== null && operation) {
              const newValue = calculate(previousValue, inputValue, operation);
              const calculation = `${formatNumber(previousValue)} ${operation} ${formatNumber(inputValue)} = ${formatNumber(newValue)}`;
              setHistory(prev => [calculation, ...prev.slice(0, 19)]);
              setDisplay(String(newValue));
              setPreviousValue(null);
              setOperation(null);
              setWaitingForOperand(true);
            }
          };

          const storeMemory = (key) => {
            const value = parseFloat(display);
            setMemory(prev => ({ ...prev, [key]: value }));
            setHistory(prev => [`Stored ${key.toUpperCase()}: ${formatNumber(value)}`, ...prev.slice(0, 19)]);
          };

          const formatNumber = (num) => {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            if (Math.abs(num) >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (Math.abs(num) >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (Math.abs(num) >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
          };

          const Button = ({ onClick, className = '', children, variant = 'default', size = 'normal' }) => {
            const baseClasses = 'font-semibold rounded-lg transition-all duration-200 active:scale-95 shadow-sm border';
            const sizes = {
              normal: 'h-10 sm:h-12 text-xs sm:text-sm px-2 sm:px-3',
              small: 'h-8 sm:h-10 text-xs px-1 sm:px-2',
              large: 'h-12 sm:h-14 text-sm sm:text-base px-3 sm:px-4'
            };
            
            const variants = isDarkMode ? {
              default: 'bg-gray-700 hover:bg-gray-600 text-gray-100 border-gray-600 hover:border-gray-500',
              operator: 'bg-gray-800 hover:bg-gray-700 text-yellow-400 border-gray-600 hover:border-yellow-400',
              equals: 'bg-yellow-500 hover:bg-yellow-400 text-black font-bold border-yellow-400',
              function: 'bg-gray-800 hover:bg-gray-700 text-blue-400 border-gray-600',
              clear: 'bg-red-600 hover:bg-red-500 text-white border-red-500',
              ib: 'bg-yellow-600 hover:bg-yellow-500 text-black font-semibold border-yellow-500',
              memory: 'bg-purple-600 hover:bg-purple-500 text-white border-purple-500',
              theme: 'bg-gray-600 hover:bg-gray-500 text-yellow-400 border-gray-500 hover:border-yellow-400',
              help: 'bg-blue-600 hover:bg-blue-500 text-white border-blue-500 hover:border-blue-400',
              install: 'bg-gray-600 hover:bg-gray-500 text-yellow-400 border-gray-500 hover:border-yellow-400 animate-pulse'
            } : {
              default: 'bg-white hover:bg-gray-50 text-black border-gray-400 hover:border-gray-500 shadow-md',
              operator: 'bg-orange-500 hover:bg-orange-600 text-white border-orange-500 shadow-md',
              equals: 'bg-green-600 hover:bg-green-700 text-white font-bold border-green-600 shadow-md',
              function: 'bg-blue-600 hover:bg-blue-700 text-white border-blue-600 shadow-md',
              clear: 'bg-red-600 hover:bg-red-700 text-white border-red-600 shadow-md',
              ib: 'bg-purple-600 hover:bg-purple-700 text-white font-semibold border-purple-600 shadow-md',
              memory: 'bg-indigo-600 hover:bg-indigo-700 text-white border-indigo-600 shadow-md',
              theme: 'bg-amber-500 hover:bg-amber-600 text-black border-amber-500 hover:border-amber-600 shadow-md',
              help: 'bg-cyan-600 hover:bg-cyan-700 text-white border-cyan-600 shadow-md',
              install: 'bg-amber-500 hover:bg-amber-600 text-black border-amber-500 hover:border-amber-600 shadow-md animate-pulse'
            };
            
            return (
              <button
                className={`${baseClasses} ${sizes[size]} ${variants[variant]} ${className}`}
                onClick={onClick}
              >
                {children}
              </button>
            );
          };

          return (
            <div className={`max-w-4xl mx-auto rounded-2xl shadow-2xl p-3 sm:p-4 md:p-6 mt-4 sm:mt-6 md:mt-8 border transition-all duration-300 ${
              isDarkMode 
                ? 'bg-gray-900 border-gray-700' 
                : 'bg-white border-gray-200'
            }`}>
              {/* Header */}
              <div className="text-center mb-4 sm:mb-6">
                <div className="flex items-center justify-between mb-3 sm:mb-4">
                  <Button
                    variant="help"
                    size="small"
                    onClick={() => setShowTutorial(true)}
                    className="w-10 sm:w-12 h-6 sm:h-8 flex items-center justify-center text-xs sm:text-sm"
                  >
                    <span className="text-xs sm:text-sm">❓</span>
                  </Button>
                  
                  <div className="flex flex-col items-center">
                    <h1 className={`text-xl sm:text-2xl md:text-3xl font-bold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                      Investment Banking Calculator
                    </h1>
                    {showInstallButton && (
                      <Button
                        variant="install"
                        size="small"
                        onClick={() => {
                          console.log('🖱️ Install button clicked');
                          if (window.deferredPrompt) {
                            console.log('📱 Showing install prompt...');
                            window.deferredPrompt.prompt();
                            window.deferredPrompt.userChoice.then((choiceResult) => {
                              console.log('👤 User choice:', choiceResult.outcome);
                              if (choiceResult.outcome === 'accepted') {
                                console.log('✅ User accepted the install prompt');
                                setShowInstallButton(false);
                              } else {
                                console.log('❌ User dismissed the install prompt');
                              }
                              window.deferredPrompt = null;
                            }).catch((error) => {
                              console.error('❗ Error during install prompt:', error);
                              setShowInstallButton(false);
                            });
                          } else {
                            console.log('⚠️ No install prompt available');
                            setShowInstallButton(false);
                          }
                        }}
                        className="mb-2 px-4 py-2 text-sm"
                      >
                        📱 Install App
                      </Button>
                    )}
                  </div>
                  
                  <Button
                    variant="theme"
                    size="small"
                    onClick={() => setIsDarkMode(!isDarkMode)}
                    className="w-10 sm:w-12 h-6 sm:h-8 flex items-center justify-center text-xs sm:text-sm"
                  >
                    {isDarkMode ? '☀️' : '🌙'}
                  </Button>
                </div>
                <p className={`text-xs sm:text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-800'}`}>
                  Professional financial modeling and analysis tool by MissCept
                </p>
              </div>

              {/* Debug Panel */}
              <div className={`mb-4 p-3 rounded-lg border text-xs ${
                isDarkMode ? 'bg-gray-800 border-gray-600 text-gray-300' : 'bg-blue-50 border-blue-200 text-gray-700'
              }`}>
                <div className="font-semibold mb-2">🔧 PWA Debug Panel</div>
                <div className="space-y-1">
                  <div>Protocol: {location.protocol}</div>
                  <div>Browser: {navigator.userAgent.includes('Chrome') ? 'Chrome' : navigator.userAgent.includes('Safari') ? 'Safari' : 'Other'}</div>
                  <div>Standalone: {window.matchMedia('(display-mode: standalone)').matches ? 'Yes' : 'No'}</div>
                  <div>SW Support: {'serviceWorker' in navigator ? 'Yes' : 'No'}</div>
                  <div>Manifest Link: {document.querySelector('link[rel="manifest"]') ? 'Found' : 'Missing'}</div>
                  <div>Install Button: {showInstallButton ? 'Showing' : 'Hidden'}</div>
                  <div>Deferred Prompt: {typeof window.deferredPrompt !== 'undefined' && window.deferredPrompt ? 'Available' : 'Not Available'}</div>
                </div>
              </div>

              {/* Display */}
              <div className="mb-4 sm:mb-6">
                <div className={`p-4 sm:p-6 rounded-xl mb-3 sm:mb-4 border transition-all duration-300 ${
                  isDarkMode 
                    ? 'bg-black text-white border-gray-600' 
                    : 'bg-gray-100 text-black border-gray-400 shadow-inner'
                }`}>
                  <div className="text-right text-xl sm:text-2xl md:text-3xl font-mono overflow-hidden mb-2">
                    {formatNumber(parseFloat(display) || 0)}
                  </div>
                  <div className={`text-right text-sm sm:text-lg mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    {parseFloat(display) >= 1000000 ? `${parseFloat(display).toLocaleString()}` : display}
                  </div>
                </div>

                {/* Mode Selector */}
                <div className="flex gap-1 sm:gap-2 mb-3 sm:mb-4">
                  {[
                    { key: 'basic', label: 'BASIC' },
                    { key: 'dcf', label: 'DCF' },
                    { key: 'comps', label: 'COMPS' },
                    { key: 'lbo', label: 'LBO' },
                    { key: 'forex', label: 'FOREX' }
                  ].map((m) => (
                    <Button
                      key={m.key}
                      variant={mode === m.key ? 'ib' : 'default'}
                      size="small"
                      onClick={() => setMode(m.key)}
                      className="flex-1 text-xs sm:text-sm"
                    >
                      {m.label}
                    </Button>
                  ))}
                </div>

                {/* History */}
                {history.length > 0 && (
                  <div className={`p-3 rounded-lg max-h-32 overflow-y-auto border transition-all duration-300 ${
                    isDarkMode 
                      ? 'bg-gray-800 border-gray-600' 
                      : 'bg-gray-100 border-gray-200'
                  }`}>
                    <div className="flex justify-between items-center mb-2">
                      <div className={`text-xs ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>History</div>
                      <Button
                        variant="clear"
                        size="small"
                        onClick={() => setHistory([])}
                        className="h-5 px-2 text-xs"
                      >
                        Clear
                      </Button>
                    </div>
                    {history.slice(0, 5).map((calc, index) => (
                      <div key={index} className={`text-xs font-mono mb-1 p-1 rounded transition-all duration-300 ${
                        isDarkMode 
                          ? 'text-gray-300 bg-gray-700' 
                          : 'text-gray-700 bg-white border border-gray-200'
                      }`}>
                        {calc}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Basic Calculator Layout */}
              <div className="space-y-2 sm:space-y-3">
                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button variant="clear" onClick={clear}>AC</Button>
                  <Button variant="function" onClick={() => setDisplay(display.slice(0, -1) || '0')}>⌫</Button>
                  <Button variant="function" onClick={() => {
                    const val = parseFloat(display) || 0;
                    setDisplay(String(Math.sqrt(val).toFixed(4)));
                    setWaitingForOperand(true);
                  }}>√</Button>
                  <Button variant="function" onClick={() => performOperation('^')}>^</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button variant="operator" onClick={() => performOperation('%')}>%</Button>
                  <Button variant="operator" onClick={() => performOperation('÷')}>÷</Button>
                  <Button variant="operator" onClick={() => performOperation('×')}>×</Button>
                  <Button variant="operator" onClick={() => performOperation('-')}>-</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button onClick={() => inputNumber(7)}>7</Button>
                  <Button onClick={() => inputNumber(8)}>8</Button>
                  <Button onClick={() => inputNumber(9)}>9</Button>
                  <Button variant="function" onClick={() => {
                    const val = parseFloat(display);
                    setDisplay(String(val * 1000000));
                    setWaitingForOperand(true);
                  }}>×1M</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button onClick={() => inputNumber(4)}>4</Button>
                  <Button onClick={() => inputNumber(5)}>5</Button>
                  <Button onClick={() => inputNumber(6)}>6</Button>
                  <Button variant="function" onClick={() => {
                    const val = parseFloat(display);
                    setDisplay(String(val * 1000));
                    setWaitingForOperand(true);
                  }}>×1K</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button onClick={() => inputNumber(1)}>1</Button>
                  <Button onClick={() => inputNumber(2)}>2</Button>
                  <Button onClick={() => inputNumber(3)}>3</Button>
                  <Button variant="operator" onClick={() => performOperation('+')}>+</Button>
                </div>

                <div className="grid grid-cols-4 gap-2 sm:gap-3">
                  <Button variant="function" onClick={() => {
                    const val = parseFloat(display);
                    setDisplay(String(val * 1000000000));
                    setWaitingForOperand(true);
                  }}>×1B</Button>
                  <Button onClick={() => inputNumber(0)}>0</Button>
                  <Button onClick={inputDecimal}>.</Button>
                  <Button variant="equals" onClick={performEquals}>=</Button>
                </div>
              </div>

              {/* Footer */}
              <div className={`text-xs mt-4 sm:mt-6 text-center transition-all duration-300 ${
                isDarkMode ? 'text-gray-400' : 'text-gray-600'
              }`}>
                <div className="mb-1">IB Calculator v2.1 | Enhanced Financial Modeling Suite</div>
                <div className="hidden sm:block">DCF: Discounted Cash Flow | LBO: Leveraged Buyout | Comps: Comparable Analysis | Forex: Currency Conversion</div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<IBCalculator />, document.getElementById('root'));
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('./sw.js')
              .then(function(registration) {
                console.log('✅ Service Worker registered successfully:', registration.scope);
              })
              .catch(function(error) {
                console.log('❌ Service Worker registration failed:', error);
              });
          });
        }
    </script>
</body>
</html>
