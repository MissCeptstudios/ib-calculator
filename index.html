import React, { useState, useEffect } from 'react';

const IBCalculator = () => {
  const [display, setDisplay] = useState('0');
  const [previousValue, setPreviousValue] = useState(null);
  const [operation, setOperation] = useState(null);
  const [waitingForOperand, setWaitingForOperand] = useState(false);
  const [history, setHistory] = useState([]);
  const [mode, setMode] = useState('basic');
  const [expression, setExpression] = useState('');
  const [openParentheses, setOpenParentheses] = useState(0);
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [memory, setMemory] = useState({
    wacc: 8.5,
    terminalGrowth: 2.5,
    discountRate: 10,
    revenue: 0,
    ebitda: 0,
    netIncome: 0,
    shares: 0,
    marketCap: 0,
    enterprise: 0,
    debtEquityRatio: 4.0,
    debtEbitdaMultiple: 6.0,
    initialInvestment: 0,
    cashFlows: [],
    currentCashFlow: 0
  });

  // Exchange rates state
  const [exchangeRates, setExchangeRates] = useState({
    USD: 1.0000,
    EUR: 0.9150,
    JPY: 142.30,
    GBP: 0.7820,
    CHF: 0.8850,
    CAD: 1.3720,
    CNY: 7.2800,
    PLN: 4.0500,
    AUD: 1.4950,
    SEK: 10.8500
  });
  const [ratesLastUpdated, setRatesLastUpdated] = useState(null);
  const [isLoadingRates, setIsLoadingRates] = useState(false);
  const [apiError, setApiError] = useState(null);

  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [selectedToCurrency, setSelectedToCurrency] = useState('EUR');
  const [showTutorial, setShowTutorial] = useState(false);

  // PWA Service Worker Registration
  useEffect(() => {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('PWA: Service Worker registered successfully:', registration);
          })
          .catch((registrationError) => {
            console.log('PWA: Service Worker registration failed:', registrationError);
          });
      });
    }
  }, []);

  // Tutorial content for each mode
  const getTutorialContent = () => {
    switch (mode) {
      case 'basic':
        return {
          title: 'Basic Calculator Tutorial',
          content: [
            {
              section: 'What it does:',
              text: 'Standard calculator with financial shortcuts for quick calculations.'
            },
            {
              section: 'Key Features:',
              text: '• Standard arithmetic operations (+, -, ×, ÷)\n• Parentheses for complex expressions\n• Quick multipliers: ×1K, ×1M, ×1B\n• Percentage calculations'
            },
            {
              section: 'Example:',
              text: 'Calculate company valuation:\n1. Enter "15" (revenue in millions)\n2. Click "×1M" → 15,000,000\n3. Click "×" then "12" (multiple)\n4. Click "=" → Result: 180M valuation'
            }
          ]
        };
      
      case 'dcf':
        return {
          title: 'DCF (Discounted Cash Flow) Tutorial',
          content: [
            {
              section: 'What it does:',
              text: 'Values a company based on projected future cash flows discounted to present value.'
            },
            {
              section: 'How to use:',
              text: '1. Set WACC (Weighted Average Cost of Capital)\n2. Set Terminal Growth rate\n3. Enter current Free Cash Flow\n4. Click "DCF Model" for valuation'
            },
            {
              section: 'Example:',
              text: 'Value a tech company:\n1. Enter "8.5" → Click "Set WACC" (8.5%)\n2. Enter "2.5" → Click "Set TG" (2.5%)\n3. Enter "100" (FCF in millions)\n4. Click "×1M" then "DCF Model"\n→ Result: Enterprise Value'
            }
          ]
        };
      
      case 'comps':
        return {
          title: 'Comparable Analysis Tutorial',
          content: [
            {
              section: 'What it does:',
              text: 'Values companies using trading multiples from similar public companies.'
            },
            {
              section: 'How to use:',
              text: '1. Set Enterprise Value and Market Cap\n2. Enter financial metrics (Revenue, EBITDA)\n3. Click multiple buttons to calculate ratios'
            }
          ]
        };
      
      case 'lbo':
        return {
          title: 'LBO (Leveraged Buyout) Tutorial',
          content: [
            {
              section: 'What it does:',
              text: 'Models private equity acquisitions using debt and equity financing.'
            },
            {
              section: 'How to use:',
              text: '1. Enter equity investment amount\n2. Use "LBO Size" to calculate total deal size\n3. Use "Debt Cap" for maximum debt capacity\n4. Calculate IRR and MOIC returns'
            }
          ]
        };

      case 'irr_npv':
        return {
          title: 'IRR/NPV Analysis Tutorial',
          content: [
            {
              section: 'What it does:',
              text: 'Evaluates investment opportunities using Internal Rate of Return and Net Present Value analysis.'
            },
            {
              section: 'How to use:',
              text: '1. Set initial investment (negative cash flow)\n2. Add future cash flows year by year\n3. Set discount rate for NPV calculation\n4. Calculate NPV, IRR, and payback metrics'
            }
          ]
        };
      
      case 'forex':
        return {
          title: 'Foreign Exchange Tutorial',
          content: [
            {
              section: 'What it does:',
              text: 'Converts currencies using live exchange rates from reliable financial APIs.'
            },
            {
              section: 'How to use:',
              text: '1. Select source and target currencies\n2. Enter amount to convert\n3. Click "Convert" or "Get Rate"\n4. Use swap button (⇄) to reverse currencies'
            }
          ]
        };
      
      default:
        return { title: 'Calculator Tutorial', content: [] };
    }
  };

  // API function for exchange rates
  const fetchExchangeRates = async () => {
    setIsLoadingRates(true);
    setApiError(null);
    
    try {
      // Demo mode with realistic mock data
      await new Promise(resolve => setTimeout(resolve, 800));
      
      const mockData = {
        rates: {
          EUR: 0.9234 + (Math.random() - 0.5) * 0.02,
          JPY: 147.85 + (Math.random() - 0.5) * 3,
          GBP: 0.7912 + (Math.random() - 0.5) * 0.015,
          CHF: 0.8923 + (Math.random() - 0.5) * 0.012,
          CAD: 1.3567 + (Math.random() - 0.5) * 0.025,
          CNY: 7.2456 + (Math.random() - 0.5) * 0.15,
          PLN: 4.0234 + (Math.random() - 0.5) * 0.08,
          AUD: 1.5123 + (Math.random() - 0.5) * 0.03,
          SEK: 10.7834 + (Math.random() - 0.5) * 0.25
        }
      };
      
      setExchangeRates({
        USD: 1.0000,
        ...mockData.rates
      });
      setRatesLastUpdated(new Date());
      setIsLoadingRates(false);
    } catch (error) {
      setApiError('Exchange rate service temporarily unavailable');
      setIsLoadingRates(false);
    }
  };

  // Fetch rates immediately when app loads
  useEffect(() => {
    fetchExchangeRates();
  }, []);

  // Also refresh when entering forex mode if data is stale
  useEffect(() => {
    if (mode === 'forex') {
      const timer = setTimeout(() => {
        if (!ratesLastUpdated || (new Date() - ratesLastUpdated) > 300000) {
          fetchExchangeRates();
        }
      }, 1000);
      
      return () => clearTimeout(timer);
    }
  }, [mode]);

  // Basic calculator functions
  const inputNumber = (num) => {
    if (waitingForOperand) {
      setDisplay(String(num));
      setWaitingForOperand(false);
    } else {
      setDisplay(display === '0' ? String(num) : display + num);
    }
  };

  const inputDecimal = () => {
    if (waitingForOperand) {
      setDisplay('0.');
      setWaitingForOperand(false);
    } else if (display.indexOf('.') === -1) {
      setDisplay(display + '.');
    }
  };

  const clear = () => {
    setDisplay('0');
    setPreviousValue(null);
    setOperation(null);
    setWaitingForOperand(false);
    setExpression('');
    setOpenParentheses(0);
  };

  const addParenthesis = (type) => {
    if (type === 'open') {
      if (waitingForOperand || display === '0') {
        setExpression(prev => prev + '(');
        setDisplay('(');
        setOpenParentheses(prev => prev + 1);
        setWaitingForOperand(true);
      } else {
        setExpression(prev => prev + display + '*(');
        setDisplay('(');
        setOpenParentheses(prev => prev + 1);
        setWaitingForOperand(true);
      }
    } else if (type === 'close' && openParentheses > 0) {
      setExpression(prev => prev + display + ')');
      se
